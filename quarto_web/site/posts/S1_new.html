<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-07-20">

<title>Interview with Award Winners for the Interface of Statistics and AI</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body>

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Interview with Award Winners at the Interface of Statistics and AI</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Interviews</div>
  </div>
  </div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 20, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>





    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&amp;display=swap" rel="stylesheet">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview with Award Winners at the Interface of Statistics and AI(1)</title>

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://statsupai.org/pages/S1_award_interview.html">
    <meta property="og:title" content="Interview with Award Winners at the Interface of Statistics and AI">
    <meta property="og:description" content="Edgar Dobriban is an associate professor in the Department of Statistics and Data Science at the University of Pennsylvania, with a secondary appointment in Computer and Information Science.">
    <meta property="og:image" content="figures/s1_new2.jpg">
    <style>
        body {
            font-family: 'Roboto', sans-serif; 
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            line-height: 1.6; /* 增加行距 */
        }
        .large-text {
            font-size: larger; /* 或你想要的任何大小 */
        }

        .interviewee-introduction {
            display: flex;
            align-items: center;
            background-color: #f8f8f8; /* 轻灰色背景 */
            border-radius: 8px; /* 边角圆润 */
            padding: 20px;
            margin-bottom: 20px; /* 和问答部分保持一定距离 */
        }

        .interviewee-photo {
            width: 150px; /* 根据需要调整 */
            height: 150px; /* 根据需要调整 */
            border-radius: 50%; /* 创建圆形图片 */
            object-fit: cover; /* 确保图片内容适应尺寸 */
            margin-right: 20px;
        }

        .interviewee-details h2 {
            margin-top: 0;
            color: #082653; /* 深蓝色，你可以根据网站主题更改 */
        }

        .interviewee-details p {
            color: #333; /* 深灰色文本 */
            line-height: 1.6; /* 增加行距 */
        }
        .edit-info {
            color: #808080; /* 设置为灰色字体 */
            font-size: 15px; /* 设置字体大小，根据需要调整 */
            text-align: right; /* 右对齐文本 */
            padding: 20px 0; /* 在内容上下添加一些空间 */
            margin-top: 20px; /* 与问答内容保持一定距离 */
            border-top: 1px solid #ccc; /* 如果需要，可以添加一条分隔线 */
        }

        .header-image {
            width: 97%;
            height: auto;
            display: block; /* 使图片成为块级元素 */
            margin: 0 auto; /* 水平居中 */
        }
        .fixed-counter {
            position: fixed; /* 固定定位，使元素不随页面滚动 */
            left: 0; /* 距离页面左边界的距离 */
            bottom: 0; /* 距离页面底部边界的距离 */
            background-color: transparent; /* 可以根据需要设置背景颜色 */
            z-index: 1000; /* 确保计数器显示在其他元素之上 */
        }

        .interview {
        margin: 20px;
        background-color: rgba(255, 255, 255, 0.7); /* 白色背景，70%不透明度（即30%透明度） */
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* 标题和子标题 */
        h1, h2 {
            font-weight: bold;
            color: #7469B6; /* 深蓝色 */
            margin-bottom: 20px;
        }

        /* 问题样式 */
        .question {
            color: #213c64; /* 深蓝色 */
            font-weight: bold;
            margin-bottom: 10px; /* 问题与回答之间的空间 */
            font-size: larger; /* 突出问题 */
        }
        .image {
            display: block; /* 使图像成为块级元素 */
            max-width: 60%; /* 设置图像的最大宽度为60%以确保响应式 */
            height: auto; /* 设置图像的高度自动调整以保持图片比例 */
            margin: 10px auto; /* 上下边距为20px，左右自动，实现水平居中 */
            border: 5px solid #808080; /* 添加蓝色的边框，宽度为5px */
            border-radius: 8px; /* 如果您想要圆角边框，可以添加这个属性 */
        }

        .answer {
            background-color: #f8f8f8; /* 轻微的背景色增加对比 */
            padding: 15px; /* 内边距增加可读性 */
            border-left: 4px solid #213c64; /* 左侧边框作为视觉提示 */
            margin-bottom: 20px; /* 增加回答间的空间 */
            color: #264653; /* 适中的文字颜色 */
            font-size: medium; /* 适合阅读的字号 */
            line-height: 1.6; /* 行间距增加可读性 */
            border-radius: 4px; /* 轻微的圆角 */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* 轻微的阴影增加层次感 */
        }
        ul.custom-list {
        padding-left: 20px; /* 调整以适应项目符号和首行缩进 */
        }
        ul.custom-list li {
            text-indent: 2em; /* 首行缩进 */
            margin-left: -2em; /* 调整项目符号位置 */
        }

        .background-image {
            position: fixed; /* 或absolute，取决于你的需求 */
            right: 0;
            bottom: 0;
            width: 800px; /* 根据你的背景图尺寸调整 */
            height: 300px; /* 根据你的背景图尺寸调整 */
            background-image: url('12.jpg'); /* 替换为你的图片名称 */
            background-size: cover;
            opacity: 0.4; /* 设置透明度为40% */
            z-index: -1; /* 确保背景图不会覆盖其他内容 */
        }
        .article-link {
            background-color: #f4f4f4; /* 背景色 */
            padding: 10px; /* 内边距 */
            border-radius: 8px; /* 边角圆滑 */
            text-align: center; /* 文本居中 */
            margin: 20px 0; /* 上下外边距 */
        }
    
        .article-link p {
            margin: 0; /* 移除默认边距 */
            color: #003366; /* 文本颜色 */
            font-weight: bold; /* 字体加粗 */
        }
    
        .article-link a {
            display: inline-block; /* 可以设置宽度和高度 */
            background-color: #213c64; /* 链接背景色 */
            color: white; /* 链接文字颜色 */
            padding: 10px 20px; /* 链接内边距 */
            border-radius: 5px; /* 链接边角圆滑 */
            text-decoration: none; /* 去掉下划线 */
            font-size: 18px; /* 字体大小 */
            margin-top: 10px; /* 与段落之间的距离 */
            transition: background-color 0.3s; /* 过渡动画 */
        }
    
        .article-link a:hover {
            background-color: #082653; /* 鼠标悬停时的背景色 */
        }
        

    </style>



    <br>
    <img class="header-image" src="figures/s1_new2.jpg" alt="Interview Image">
    
    <div class="interview">
        <p class="question">1.  Can you summarize your award-winning research and its significance for statistics and AI?</p>
        <p class="answer">Thank you for the opportunity to discuss my work! 

        Much of my research seeks to connect statistics to AI and machine learning (ML). I am interested to solve AI/ML problems using statistical tools, to clarify phenomena from AI/ML using a statistical perspective, as well as to use AI/ML tools to improve statistical methods. As such, I am hoping to make advances in both AI/ML and in statistics, and furthermore enhance the public image of statistics by showing its importance to AI.
        </p>
        <p class="answer">
        Here are a few examples from my work with mentees and collaborators.

        An important emerging recent area in AI/ML concerns fairness: we want to make sure to treat various protected groups (e.g., defined based on race) “fairly”. For instance, we may want to have the same true positive rates for all protected groups, etc. This can be hard, because there is no “universal” notion of fairness. Despite this, a rich emerging body of work in fair machine learning has made a great deal of progress in defining and achieving various fairness criteria.  In recent work, we have studied the problem of fair classification from a statistical perspective.  We figured out how to learn optimal fair classifiers (minimizing classification error) subject to various fairness constraints, by making an unexpected connection to the Neyman-Pearson lemma. To me this is an exciting example showing how classical statistical tools can be used to solve problems in modern AI/ML.
        </p>

        <p class="answer">
        Another important emerging area in recent years is generative AI, and specifically large language models (LLMs), exemplified by ChatGPT, Claude, Gemini, etc. While these methods can have impressive performance on a variety of tasks (for instance on code generation), they are also prone to hallucinations. Therefore it would be helpful if they could quantify their own uncertainty and inform users when they are not sure. This has been attempted in several recent research papers, by introducing various uncertainty measures. One would expect that these measures are on average larger when the LLM’s performance is worse, a property called “rank-calibration”. In recent work, we have shown that unfortunately this is often not the case. To address this problem, have developed methods to post-process pre-trained LLMs to achieve rank-calibration.  I want to highlight that for this work, we have crucially built on intuition from the classical statistical notion of calibration, which has been investigated in statistics, meteorology, forecasting, etc since at least the 1950s, including by Sir David Cox (testing calibration was his first application of logistic regression!).
        </p>

        <p class="question">2.  What statistical methods from your research are most applicable to AI?</p>
        <p class="answer">Some of the statistical methods that I develop are directly targeted towards AI/ML. This includes the rank-calibration methodology I mentioned above. Some other methods are general statistical tools applicable quite broadly, including, but not only, to when AI/ML is used.</p>
        <p class="answer">
        For instance, I have worked on developing methods for constructing prediction sets for regression and classification problems.  The idea here is that instead of constructing a point prediction, we construct a set of predictions. In the form of tolerance regions, such ideas date back to Sam Wilks’s celebrated work in the early 1940s. Given the quality levels of items from a production line, he was interested to predict a range of values where the quality of the next item would lie with 95% probability.  In modern times, there has been renewed interest in this area under the name of conformal prediction or distribution free predictive inference, where the goal is for instance modify the outputs of our AI/ML model, so that the true class is guaranteed to be among the predicted classes with 95% probability. I have contributed to a variety of questions in this area, including developing methods that are robust to distribution shift, and methods that are more generally applicable than under standard i.i.d. or exchangeability assumptions. An exciting feature of this research is that the statistical methods developed can be used along with state-of-the-art AI/deep learning tools, endowing those tools with rigorous statistical guarantees.
        </p>

        <p class="question">3.  How does your work address challenges at the intersection of statistics and AI?</p>
        <p class="answer">From a very high level, both statistics and AI aim to fit models to data to extract information. However, AI/ML research usually does not make any explicit assumptions about the data, while in statistics we are accustomed to working with probabilistic assumptions. To give an example, neural nets have been derived not based on a probabilistic model, but rather heuristically, based on analogies with the brain. There are sometimes implicit assumptions, for instance that the data points are exchangeable or i.i.d., but they are rarely made explicit in terms of enforcing a specific probabilistic model. I think that one of the biggest challenges for statistics is to operate in this regime , where only few explicit assumptions are allowed. 
        </p>
        <p class="answer">
        My recent research is done with this in mind. Some of the work that I mentioned above about calibration and uncertainty quantification only assumes that the data is i.i.d., and so is compatible with standard deep learning/AI. In addition, some of my recent work does away entirely with statistical models, and is “pure” AI.
        </p>

        <p class="answer">
        For instance, in a recent work we have developed methods to jailbreak language models. Jailbreaking is part of the increasing safety concerns about LLMs, and refers to the process of getting an LLM to display undesired behavior, give unethical or unsafe answers, etc. While safety alignment such as reinforcement learning from human feedback (RLHF) aims to remove such undesired behaviors, we have shown in recent research that jailbreaking is often possible through automated querying via another language model. Since evaluating jailbreaks has often been done in an ad hoc way, we have also developed the standardized JailbreakBench benchmark as a publicly available tool for the field. While these works do not have a clear statistical component, I found it valuable to work on them due to their importance.
        </p>

        <p class="question">4.  What impact do you foresee your research having on the future of AI systems?</p>
        <p class="answer">AI is evolving at a fast pace, and so it is hard to predict the direction of the field, much less the kind of impact that my own work will have. However I do hope that---in the long-term---my work will contribute to making AI safer and more reliable.
        </p>
        

        <p class="question">5.  What emerging trends in statistics do you believe are crucial for advancing AI?</p>
        <p class="answer">I think that for the field of statistics, it is important that at least a fraction of researchers become fully engaged in AI. Given the growing level of interest and funding from many stakeholders, we want to make sure that we have a seat at the table when AI is discussed. We want to make sure that it is clear that statistics is an integral part of AI,  and that statisticians have been making important contributions to what is now called AI for a hundred years. For instance the notions of maximum likelihood, calibration, distributional robustness, bandits, etc.,  are all key topics of research in modern AI, and have been introduced or pioneered by statisticians or in statistics journals over many decades. To enhance the public image of our field, I think it is very important that this is widely known.</p>

        <p class="answer">
        To summarize, I believe that an important trend in statistics that we need to see is that statisticians engage with AI, keep making contributions in any area where they see an opportunity, and highlight other statisticians’ contributions to AI from the past and the present.
        </p>

        

        <!-- 添加更多问题和答案 -->

    </div>
    <div class="edit-info">
        Edited by: Shan Gao<br>
        Proofread by: Hongtu Zhu
    </div>
<div class="background-image"></div>
<!-- Default Statcounter code for Interview_peiwang
https://statsupai.com/pages/interview_weipeng.html -->
<div style="display: flex; align-items: center; color: #8E8E8E; font-size: 13px; font-family: Arial, sans-serif;">Page Views: <div class="statcounter" style="margin-left: 10px;"> <!-- Add this line for styling -->
<!-- Default Statcounter code for s1_new
https://statsupai.org/quarto_web/site/posts/S1_new.html -->
<script type="text/javascript">
var sc_project=13019954; 
var sc_invisible=0; 
var sc_security="f0554f6e"; 
var scJsHost = "https://";
document.write("<sc"+"ript type='text/javascript' src='" +
scJsHost+
"statcounter.com/counter/counter.js'></"+"script>");
</script>
<noscript><div class="statcounter"><a title="Web Analytics"
href="https://statcounter.com/" target="_blank"><img
class="statcounter"
src="https://c.statcounter.com/13019954/0/f0554f6e/0/"
alt="Web Analytics"
referrerPolicy="no-referrer-when-downgrade"></a></div></noscript>
<!-- End of Statcounter Code -->





</div></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>
