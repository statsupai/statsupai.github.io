name: Auto request review (ping maintainer)

on:
  pull_request_target:
    types: [opened, reopened, ready_for_review]

permissions:
  pull-requests: write

jobs:
  request-review:
    runs-on: ubuntu-latest
    steps:
      - name: Request review from maintainer
        uses: actions/github-script@v7
        with:
          script: |
            const me = "yulinl2";
            const pr = context.payload.pull_request;

            // Skip drafts (they'll get handled on ready_for_review)
            if (pr.draft) return;

            // Skip if the PR author is the same as `me` (GitHub doesn't allow self-review requests)
            const authorLogin = pr.user && pr.user.login ? pr.user.login.toLowerCase() : null;
            const meLogin = me.toLowerCase();
            if (authorLogin && authorLogin === meLogin) return;
            try {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                reviewers: [me],
              });
            } catch (error) {
              // Known 4xx cases (e.g. non-collaborator, already requested) shouldn't fail the workflow
              if (error && error.status >= 400 && error.status < 500) {
                core.warning(
                  `Skipping auto reviewer request for "${me}": ${error.message} (status ${error.status}).`
                );
                return;
              }
              // Re-throw unexpected errors so the job still fails appropriately
              throw error;
            }
